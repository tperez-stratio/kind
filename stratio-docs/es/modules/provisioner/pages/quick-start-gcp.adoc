:toc: left
:toclevels: 4

= _Stratio KEOS_ en clouds: GCP Quick Start Guide

VersiÃ³n: 0.1.0

== Prerrequisitos en el cloud provider:

* Crear una IAM Service Account con los permisos definidos en xref:./stratio-gcp-permissions.list[stratio-gcp-permissions.list].
* Crear una clave privada para la IAM Service Account de tipo JSON y descargarla en un fichero _<project_name>-<id>.json_. Estos datos se utilizarÃ¡n para las credenciales solicitadas en el descriptor del cluster.
* Desplegar un "Cloud NAT" en la regiÃ³n (requiere un "Cloud Router", pero se puede crear en el propio wizard).

* Zonas privada y pÃºblica en Cloud DNS creadas en GCP (opcional).

* Infra custom creada en GCP (opcional).

* Componer el fichero descriptor del cluster.
** Credenciales del usuario (private_key_id, private_key y client_email) y datos de la cuenta (regiÃ³n y project_id), que se cifrarÃ¡n en la primera ejecuciÃ³n.
** Token de Github para descarga de templates.
** Datos de la infraestructura ya creada (opcional).
** Zona DNS de las zonas creadas (opcional).
** Datos del Docker registry (URL, credenciales).
** Dominio externo del cluster.
** Control plane.
** Grupos de nodos.
** InformaciÃ³n necesaria para la instalaciÃ³n de _Stratio KEOS_.

A continuaciÃ³n se indican los detalles del control plane, nodos workers y keos, para mÃ¡s detalles ver la guÃ­a de instalaciÃ³n.

=== Control plane nodes

Para este provider, el control-plane se desplegarÃ¡ en mÃ¡quinas virtuales, por ello, se podrÃ¡n configurar las siguientes opciones:

* highly_available: define si el control-plane contarÃ¡ con alta disponibilidad (por defecto: true).
* managed: indica que se trata de un control-plane en mÃ¡quinas virtuales.
* size: tipo de instancia.
* node_image: imÃ¡gen de los nodos del control-plane. La imÃ¡gen indicada deberÃ¡ existir en el project referenciado.
* root_volume: particularidades del disco (opcional).
** size: tamaÃ±o en Gb (por defecto: 30Gb).
** type: tipo de disco (por defecto: gp2).
** encrypted: cifrado del disco (por defecto: false).

=== Worker nodes

En el descriptor del cluster se pueden indicar grupos de nodos worker con las siguientes opciones:

* name: nombre del grupo, no puede repetirse. Debe comenzar con "<nombre del cluster>-".
* size: tipo de instancia.
* quantity: cantidad de workers en el grupo.
* min_size: nÃºmero mÃ­nimo de nodos para el autoescalado (opcional).
* max_size: nÃºmero mÃ¡ximo de nodos para el autoescalado (opcional).
* labels: labels de los nodos en Kubernetes (opcional).
* root_volume: particularidades del disco (opcional).
** size: tamaÃ±o en Gb (por defecto: 30Gb).
** type: tipo de disco (por defecto: gp2).
** encrypted: cifrado del disco (por defecto: false).
* ssh_key: clave SSH para acceso a los nodos (opcional). Debe existir en el provider.
* spot: indica si la instancia es de tipo spot (opcional).
* node_image: imÃ¡gen de los nodos worker. La imÃ¡gen indicada deberÃ¡ existir y ser compatible con EKS.
* zone_distribution: indica si la cantidad de nodos debe quedar balanceada en las zonas o no (por defecto: balanced).
* az: zona del grupo de workers (opcional). En caso de especificarse, sÃ³lamente se utilizarÃ¡ Ã©sta para todo el grupo. Este parÃ¡metro invalida lo especificado en zone_distribution.

Nota: Por defecto, el reparto de nodos se harÃ¡ en las zonas a, b y c de la regiÃ³n indicada de forma balanceada, por lo tanto, el resto de la divisiÃ³n por tres de la cantidad de nodos se descartarÃ¡. Ejemplo: si se indica quantity=7, sÃ³lo se desplegarÃ¡n 2 nodos en cada una de las zonas.

=== keos-installer

A modo de facilitar la instalaciÃ³n de _Stratio KEOS_, en el proceso de provisiÃ³n se genera un fichero keos.yaml funcional y listo para poder lanzar la instalaciÃ³n. Para ello, en el descriptor del cluster podremos indicar la versiÃ³n y flavour (production, development o minimal).

----
  keos:
    version: 0.8.1
    flavour: development
----

Para cualquier personalizaciÃ³n extra, deberÃ¡ modificarse el fichero antes de ejecutar el keos-installer.

=== Consideraciones

* Â·En caso de utilizar infraestructura custom, se deberÃ¡ indicar la VPC y 3 subnets, una por zona de la regiÃ³n (a, b y c).
* La versiÃ³n de Kubernetes configurada debe ser la soportada en las imÃ¡genes indicadas.
* Los nombres de los grupos de worker_nodes no pueden repetirse y deben comenzar con "<nombre del cluster>-".

== InstalaciÃ³n

Esta fase (aprovisionamiento e instalaciÃ³n de Kubernetes), deberÃ¡ ejecutarse desde una mÃ¡quina Linux con acceso a internet y Docker instalado. 

Una vez descargado el fichero .tgz del cloud-provisioner, procedemos a descomprimirlo y ejecutarlo con los parÃ¡metros de creaciÃ³n:

----
$ tar xvzf cloud-provisioner-*tar.gz
$ sudo ./bin/cloud-provisioner create cluster --name <cluster_id> --descriptor cluster.yaml
Creating temporary cluster "example-gcp" ...
 âœ“ Ensuring node image (kindest/node:v1.24.7) ğŸ–¼
 âœ“ Building Stratio image (stratio-capi-image:v1.24.7) ğŸ“¸
 âœ“ Preparing nodes ğŸ“¦  
 âœ“ Writing configuration ğŸ“œ 
 âœ“ Starting control-plane ğŸ•¹ï¸ 
 âœ“ Installing CNI ğŸ”Œ 
 âœ“ Installing StorageClass ğŸ’¾ 
 âœ“ Installing CAPx ğŸ–ï¸ 
 âœ“ Generating workload cluster manifests ğŸ“
 âœ“ Generating secrets file ğŸ“ğŸ—ï¸ 
 âœ“ Creating the workload cluster ğŸ’¥ 
 âœ“ Saving the workload cluster kubeconfig ğŸ“ 
 âœ“ Installing Calico in workload cluster ğŸ”Œ 
 âœ“ Installing StorageClass in workload cluster ğŸ’¾ 
 âœ“ Preparing nodes in workload cluster ğŸ“¦ 
 âœ“ Enabling workload cluster's self-healing ğŸ¥ 
 âœ“ Installing CAPx in workload cluster ğŸ–ï¸ 
 âœ“ Adding Cluster-Autoescaler ğŸ—š 
 âœ“ Moving the management role ğŸ—ï¸ 
 âœ“ Generating the KEOS descriptor ğŸ“

The cluster has been installed, please refer to Stratio KEOS documentation on how to proceed.

----

== Siguientes pasos

En este punto, tendremos un cluster de Kubernetes con las caracterÃ­sticas indicadas en el descriptor, y podremos acceder al APIserver con el kubeconfig generado en el directorio actual (.kube/config):

----
$ kubectl --kubeconfig .kube/config get nodes
----

A continuaciÃ³n procederemos a desplegar _Stratio KEOS_ utilizando el *keos-installer*.

