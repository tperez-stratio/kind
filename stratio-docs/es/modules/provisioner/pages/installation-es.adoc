:toc: left
:toclevels: 4

= _Stratio KEOS_ en clouds: InstalaciÃ³n

VersiÃ³n: 0.1.0

== InstalaciÃ³n

=== Prerrequisitos


===== [EKS]

* Roles y polÃ­ticas

Para el aprovisionamiento automatizado en EKS, se necesita ejecutar acciones sobre diversos servicios de AWS como ec2, ecr, eks, elasticloadbalancing, etc.

Si bien la utilizaciÃ³n o no de estas acciones dependerÃ¡ del tipo de instalaciÃ³n, el provisioner valida que el usuario indicado tenga estos permisos para poder ejecutarse con normalidad.

xref:./EKS-policy.json[Descargar permisos para EKS]

* Sistemas Operativos certificados

Para asegurar las funcionalidades soportadas por el control-plane gestionado de EKS, se deberÃ¡ utilizar cualquier AMI provista por AWS especÃ­ficamente para este fin.

Las https://docs.aws.amazon.com/eks/latest/userguide/eks-optimized-ami.html[AMIs optimizadas para Amazon EKS] se crean sobre el Sistema Operativo _Amazon Linux 2_.

===== [GCP]

* Permisos

Para los despliegues en Google Cloud Platform, se necesitarÃ¡n principalmente permisos en compute (instances, disks, images, routers, networks, etc.).

Al igual que con otros providers soportados, el aprovisionamiento requiere una cuenta con todos los permisos solicitados.

xref:./GCP-permissions.list[Descargar permisos para GCP]


* Sistemas Operativos certificados

Para los entornos en GCP, se deberÃ¡ utilizar https://github.com/kubernetes-sigs/image-builder/tree/master/images/capi[_image builder_], una herramienta oficial que permite crear y disponibilizar imÃ¡genes para _Stratio KEOS_.

El Sistema Operativo recomendado actualmente para este provider es _Ubuntu 22.04_.

=== Infraestructura propia

Si bien una de las ventajas de la creaciÃ³n de recursos automÃ¡tica en el aprovisionamiento es el gran dinamismo que otorga, por motivos de seguridad y compliance, muchas veces es necesario crear ciertos recursos previo al despliegue de _Stratio KEOS_ en el _cloud provider_.

En este sentido, el provisioner permite utilizar tanto un VPC como subnets previamente creadas utilizando el parÃ¡metro _networks_ en el descriptor del cluster, como veremos a continuaciÃ³n.

=== Descriptor del cluster

Para indicar las particularidades del cluster se utiliza el objeto KeosCluster en un fichero manifest.

La cabecera de este descriptor serÃ¡ la misma que cualquier objeto de Kubernetes:

----
apiVersion: installer.stratio.com/v1beta1
kind: KeosCluster
spec:
----


==== spec

El spec del KeosCluster estÃ¡ compuesto por los siguientes campos:

[cols="1,4,1,1"]
|===
^|Nombre ^|DescripciÃ³n ^|Ejemplo ^|Opcional

|cluster_id
|Nombre del cluster.
|my-cluster
|No

|infra_provider
|Nombre del _cloud provider_ (eks o gcp).
|eks
|No

|<<credentials,credentials>>
|Set de credenciales del _cloud provider_ usadas en el aprovisionamiento.
|ver el <<ejemplo_de_descriptor,Ejemplo de descriptor>>
|Si en 1a ejecuciÃ³n

|k8s_version
|VersiÃ³n de Kubernetes del cluster. Debe estar alineada tanto con EKS como con _Stratio KEOS_.
|v1.24.10
|No

|region
|RegiÃ³n del _cloud provider_ usada para el aprovisionamiento.
|eu-west-1
|No

|<<networks,networks>>
|Identificadores de infraestructura creada previamente.
|ver el <<ejemplo_de_descriptor,Ejemplo de descriptor>>
|Si

|<<control_plane,control_plane>>
|Especificaciones para el control plane de Kubernetes.
|ver el <<ejemplo_de_descriptor,Ejemplo de descriptor>>
|No

|<<worker_nodes,worker_nodes>>
|Especificaciones de los grupos de nodos worker.
|ver el <<ejemplo_de_descriptor,Ejemplo de descriptor>>
|No

|external_domain
|Dominio externo al cluster.
|domain.ext
|No

|<<keos,keos>>
|SecciÃ³n de configuraciones para la instalaciÃ³n de KEOS.
|ver el <<ejemplo_de_descriptor,Ejemplo de descriptor>>
|No

|===

==== credentials

En la primer ejecuciÃ³n, las credenciales para el aprovisionamiento en el _cloud provider_ se indicarÃ¡n en este apartado.

Estos secretos se cifran con una passphrase solicitada desde en el aprovisionamiento en el fichero _secrets.yml_, eliminÃ¡ndose todo el apartado de credentials del descriptor.

En posteriores ejecuciones, simplemente se solicita la passphrase para desencriptar el fichero de secretos, de donde se leen las credenciales.

Los siguientes campos son considerados secretos del aprovisionamiento:

[cols="1,4,1,1"]
|===
^|Nombre ^|DescripciÃ³n ^|Ejemplo ^|Opcional

|aws
|Credenciales para acceso a AWS.
|ver el <<ejemplo_de_descriptor,Ejemplo de descriptor>>
|Cuando infra_provider=aws

|gcp
|Credenciales para acceso a GCP.
|ver el <<ejemplo_de_descriptor,Ejemplo de descriptor>>
|Cuando infra_provider=gcp

|github_token
|Token de Github.
|github_pat_11APW..
|Si

|docker_registries
|Registries de Docker accesibles por los nodos.
|-
|Si

|===

==== networks

Como se ha mencionado anteriormente, el instalador permite utilizar elementos de red del _cloud provider_ creados anteriormente (por ejemplo, por un equipo de network security), posibilitando asÃ­ las arquitecturas que mejor se adapten a nuestras necesidades.

Tanto el VPC como las subnets deberÃ¡n estar creadas en el _cloud provider_. Las subnets podrÃ¡n ser privadas o pÃºblicas, pero en Ã©ste Ãºltimo caso, deberÃ¡n contar con un NAT gateway y un Internet Gateway en el mismo VPC. En caso de indicar subnets de ambos tipos, los nodos worker se desplegarÃ¡n en subnets privadas.

_Stratio KEOS_ no gestionarÃ¡ el ciclo de vida de los objetos creados previamente.

[cols="1,4,1,1"]
|===
^|Nombre ^|DescripciÃ³n ^|Ejemplo ^|Opcional

|vpc_id
|VPC ID.
|vpc-0264503b8761ff69f
|Si

|subnets
|Array de subnet's IDs.
|- subnet_id: subnet-0df75719e234f6615
|Si

|===

==== control_plane

En este apartado se indican las particularidades para el control plane de Kubernetes.

[cols="1,4,1,1"]
|===
^|Nombre ^|DescripciÃ³n ^|Ejemplo ^|Opcional

|aws
|Valores especÃ­ficos para el loggin de EKS.
a|
[.small]
----
logging:
  api_server: true
----
|No

|managed
|Indica si el control-plane es o no gestionado en el _cloud provider_.
|true
|No

|===

==== worker_nodes

En este apartado se especifican los grupos de nodos worker y sus caracterÃ­sticas.

Las imÃ¡genes utilizadas deberÃ¡n estar soportadas por EKS (ver https://repost.aws/knowledge-center/eks-custom-linux-ami[creaciÃ³n de AMI personalizadas]).

[cols="1,4,1,1"]
|===
^|Nombre ^|DescripciÃ³n ^|Ejemplo ^|Opcional

|name
|Nombre del grupo. Se utilizarÃ¡ como prefijo de las instancias.
|eks-prod-gpu
|Si

|quantity
|Cantidad de nodos del grupo. Se recomienda que sea mÃºltiplo de 3 para no tener zonas desbalanceadas.
|15
|Si

|size
|Tipo de instancia.
|t3.medium
|Si

|max_size / min_size
|MÃ¡ximo y mÃ­nimo nÃºmero de instancias para el autoescalado.
|6 / 18.
|No

|az
|Zona para todo el grupo (invalida el parÃ¡metro zone_distribution).
|eu-east-1a
|No

|zone_distribution
|Indica si los nodos se repartirÃ¡n equitativamente en las zonas (por defecto) o no.
|unbalanced
|No

|node_image
|ImÃ¡gen de instancia utilizada para los nodos worker.
|ami-0de933c15c9b49fb5
|No

|labels
|Etiquetas de Kubernetes para los nodos worker.
a|
[.small]
----
labels:
  disktype: standard
  gpus: true
----
|No

|root_volume
|Particularidades del volÃºmen como tamaÃ±o, tipo y encripciÃ³n.
a|
[.small]
----
root_volume:
  size: 50
  type: gp2
  encrypted: true
----
|No

|ssh_key
|Clave ssh pÃºblica para acceso a los nodos worker. Debe estar creada en AWS previamente. Se recomienda no aÃ±adir ninguna clave ssh a los nodos.
|prod-key
|No

|===

==== Keos

Los parÃ¡metros para la fase del keos-installer se indicarÃ¡n en este apartado.

[cols="1,4,1,1"]
|===
^|Nombre ^|DescripciÃ³n ^|Ejemplo ^|Opcional

|flavour
|Sabor de instalaciÃ³n, que indica tamaÃ±o del cluster y resiliencia. Por defecto es "production".
|development
|No

|version
|VersiÃ³n del keos-installer.
|0.8.0
|Si

|===

==== Ejemplo de descriptor

[.small]
----
---
apiVersion: installer.stratio.com/v1beta1
kind: KeosCluster
spec:
  cluster_id: eks-prod
  infra_provider: aws
  credentials:
    aws:
      region: eu-west-1
      access_key: access_key
      account: '328367555918'
      secret_key: secret_key
    github_token: github_pat_11APW..
  k8s_version: v1.24.15
  region: eu-west-1
  networks:
    vpc_id: vpc-0264503b8761ff69f
    subnets:
      - subnet_id: subnet-0416da6767f911229
      - subnet_id: subnet-0b2f81b89456dfdfd
      - subnet_id: subnet-0df75719e234f6615
  docker_registries:
    - url: 268367799111.dkr.ecr.eu-west-1.amazonaws.com/keos
      auth_required: false
      type: ecr
      keos_registry: true
    - auth_required: true
      url: XXYYZZ.dkr.ecr.eu-west-1.amazonaws.com/keos
  control_plane:
    aws:
      logging:
        api_server: true
    managed: true
    node_image:  ami-0de933c15c9b49fb5
    highly_available: true
    size: t3.medium
  worker_nodes:
    - name: eks-prod-xlarge
      quantity: 6
      max_size: 18
      min_size: 6
      size: m6i.xlarge
      labels:
        disktype: standard
      root_volume:
        size: 50
        type: gp2
        encrypted: true
      ssh_key: stg-key
    - name: eks-prod-medium-spot
      quantity: 4
      zone_distribution: unbalanced
      size: t3.medium
      spot: true
      labels:
        disktype: standard
    - name: eks-prod-medium-az
      quantity: 3
      size: t3.medium
      az: eu-west-1c
      node_image:  ami-0de933c15c9b49fb5
  external_domain: domain.ext
  keos:
    domain: cluster.local
    flavour: production
    version: 0.8.2
---
----

=== Provisioner

El _cloud-provisioner_ es una herramienta que facilita el aprovisionamiento de los elementos necesarios en el _cloud provider_ especificado para la creaciÃ³n de un cluster de Kubernetes segÃºn el <<descriptor_del_cluster,descriptor>> especificado.

Actualmente, este binario incluye las siguientes opciones:

- --descriptor: permite indicar el path al descriptor del cluster.
- --vault-password: permite indicar la passphrase de cifrado de las credenciales.
- --avoid-creation: no se crea el cluster worker, sÃ³lo el cluster local.
- --keep-mgmt: crea el cluster worker, pero deja su gestiÃ³n en el cluster local.
- --retain: permite mantener el cluster local aÃºn sin management.

Para crear un cluster, basta con un simple comando:

-----
sudo ./cloud-provisioner create cluster --name stratio-pre --descriptor cluster-gcp.yaml
Vault Password: 
Rewrite Vault Password:
Creating temporary cluster "stratio-pre" ...
 âœ“ Ensuring node image (kindest/node:v1.24.7) ğŸ–¼
 âœ“ Building Stratio image (stratio-capi-image:v1.24.7) ğŸ“¸
 âœ“ Preparing nodes ğŸ“¦  
 âœ“ Writing configuration ğŸ“œ 
 âœ“ Starting control-plane ğŸ•¹ï¸ 
 âœ“ Installing CNI ğŸ”Œ 
 âœ“ Installing StorageClass ğŸ’¾ 
 âœ“ Installing CAPx ğŸ–ï¸ 
 âœ“ Generating workload cluster manifests ğŸ“ 
 âœ“ Generating secrets file ğŸ“ğŸ—ï¸ 
 âœ“ Creating the workload cluster ğŸ’¥ 
 âœ“ Saving the workload cluster kubeconfig ğŸ“ 
 âœ“ Installing Calico in workload cluster ğŸ”Œ 
 âœ“ Installing StorageClass in workload cluster ğŸ’¾ 
 âœ“ Preparing nodes in workload cluster ğŸ“¦ 
 âœ“ Enabling workload cluster's self-healing ğŸ¥ 
 âœ“ Installing CAPx in workload cluster ğŸ–ï¸ 
 âœ“ Adding Cluster-Autoescaler ğŸ—š 
 âœ“ Moving the management role ğŸ—ï¸ 
 âœ“ Generating the KEOS descriptor ğŸ“

The cluster has been installed, please refer to Stratio KEOS documentation on how to proceed.
-----

Una vez finalizado el proceso, tendremos los ficheros necesarios (keos.yaml y secrets.yml) para instalar KEOS.




