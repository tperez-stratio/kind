= Instalaci√≥n

== Prerrequisitos

=== EKS

* Roles y pol√≠ticas
+
Para el aprovisionamiento automatizado en EKS, se necesita ejecutar acciones sobre diversos servicios de AWS como EC2, ECR, EKS, Elastic Load Balancing (ELB), etc. Si bien la utilizaci√≥n o no de estas acciones depender√° del tipo de instalaci√≥n, el proveedor valida que el usuario indicado tenga estos permisos para poder ejecutarse con normalidad.
+
** xref:attachment$stratio-eks-policy.json[Descargar permisos permanentes para EKS]
** xref:attachment$stratio-aws-temp-policy.json[Descargar permisos temporales para EKS]
+
Para el despliegue de EKS se deber√° crear de forma manual el rol "AWSServiceRoleForAmazonEKS" y asociarle la pol√≠tica "AmazonEKSServiceRolePolicy" (creada por defecto en AWS).

* Sistemas operativos certificados
+
Para asegurar las funcionalidades soportadas por el _control-plane_ gestionado de EKS, se deber√° utilizar cualquier AMI provista por AWS espec√≠ficamente para este fin.
+
Las https://docs.aws.amazon.com/eks/latest/userguide/eks-optimized-ami.html[AMI optimizadas para Amazon EKS] se crean sobre el sistema operativo Amazon Linux 2.
+
El sistema operativo recomendado actualmente para este proveedor es Ubuntu 22.04.

* CloudFormation
+
WARNING: Si no has creado el _stack_ de CloudFormation o no has creado manualmente los requisitos de IAM previamente en la cuenta, debes establecer el par√°metro `spec:security:aws:create_iam` como _true_ (por defecto es _false_).

=== Consideraciones para im√°genes

Refiri√©ndose al _control-plane_, en EKS no se podr√° indicar una imagen.

Para los nodos _worker_, es opcional en todos los proveedores _cloud_ salvo en los casos descritos anteriormente (al no indicarla, el _controller_ asigna una disponibilizada por el proveedor _cloud_).

Al momento de crear la imagen para el _cluster_ se deber√°n tener en cuenta las necesidades de Sistema Operativo para las aplicaciones que lo requieran (_systemd units, DaemonSets_, etc.) y la versi√≥n de Kubernetes a utilizar.

==== Elasticsearch

Para soportar los despliegues de Elasticsearch, el Sistema Operativo deber√° contar con el par√°metro `max_map_count = 262144` del _sysctl_ como indica su https://www.elastic.co/guide/en/elasticsearch/reference/current/vm-max-map-count.html[documentaci√≥n oficial].

Las im√°genes de Amazon Linux 2 *utilizadas por EKS* ya cuentan con este par√°metro/valor.

== Descriptor del _cluster_

Para indicar las particularidades del _cluster_ se utiliza el objeto _KeosCluster_ en un fichero _manifest_. La cabecera de este descriptor ser√° la misma que la de cualquier objeto de Kubernetes:

[source,yaml]
----
apiVersion: installer.stratio.com/v1beta1
kind: KeosCluster
metadata:
spec:
----

=== _metadata_

Los _metadata_ del _KeosCluster_ est√°n compuestos por los siguientes campos:

[cols="1,4,2,1"]
|===
^|Nombre ^|Descripci√≥n ^|Ejemplo ^|Opcional

|_name_
|Nombre del _cluster_.
|my-cluster
|No
|===

=== _spec_

El _spec_ del _KeosCluster_ est√° compuesto por los siguientes campos:

[cols="1,4,2,1"]
|===
^|Nombre ^|Descripci√≥n ^|Ejemplo ^|Opcional

|_infra++_++provider_
|Nombre del proveedor _cloud_ (AWS).
|aws
|No

|<<credentials, _credentials_>>
|Set de credenciales del proveedor _cloud_ usadas en el aprovisionamiento.
|Ver el <<ejemplo_de_descriptor,Ejemplo de descriptor>>
|No en 1¬™ ejecuci√≥n.

|_k8s++_++version_
|Versi√≥n de Kubernetes del _cluster_. Debe estar alineada tanto con el proveedor _cloud_ como con _Stratio KEOS_. Nota: EKS no tiene en cuenta la versi√≥n _patch_.
|v1.26.8
|No

|_docker++_++registries_
|_Registries_ de Docker accesibles por los nodos.
|-
|No

|_helm++_++repository_
|Repositorio de Helm para la instalaci√≥n de los _charts_ de Stratio.
|-
|No

|_region_
|Regi√≥n del proveedor _cloud_ usada para el aprovisionamiento.
|eu-west-1
|No

|_external++_++domain_
|Dominio externo al _cluster_.
|domain.ext
|No

|<<keos, _keos_>>
|Secci√≥n de configuraciones para la instalaci√≥n de _Stratio KEOS_.
|ver el <<ejemplo_de_descriptor, Ejemplo de descriptor>>
|No

|_storageclass_
|Configuraci√≥n de la _StorageClass_ que se crear√° por defecto en el _cluster_.
|Ver el <<ejemplo_de_descriptor, Ejemplo de descriptor>>
|S√≠

|<<networks, _networks_>>
|Identificadores de la infraestructura creada previamente.
|Ver el <<ejemplo_de_descriptor, Ejemplo de descriptor>>
|S√≠

|<<control_plane, _control++_++plane_>>
|Especificaciones para el _control-plane_ de Kubernetes.
|Ver el <<ejemplo_de_descriptor, Ejemplo de descriptor>>
|No

|<<worker_nodes, _worker++_++nodes_>>
|Especificaciones de los grupos de nodos _worker_.
|ver el <<ejemplo_de_descriptor, Ejemplo de descriptor>>
|No
|===

=== Credenciales

En la primera ejecuci√≥n, las credenciales para el aprovisionamiento en el proveedor _cloud_ se indicar√°n en este apartado.

Estos secretos se cifran con una _passphrase_ solicitada desde en el aprovisionamiento en el fichero _secrets.yml_, elimin√°ndose todo el apartado de credenciales del descriptor. En posteriores ejecuciones, simplemente se solicita la _passphrase_ para descifrar el fichero de secretos, de donde se leen las credenciales.

Los siguientes campos son considerados secretos del aprovisionamiento:

[cols="1,4,2,1"]
|===
^|Nombre ^|Descripci√≥n ^|Ejemplo ^|Opcional

|aws
|Credenciales para acceso a AWS.
|Ver el <<ejemplo_de_descriptor, Ejemplo de descriptor>>
|No cuando _infra++_++provider=aws_.

|_github++_++token_
|_Token_ de GitHub. Se puede utilizar un _Fine-grained token_ o un _token_ tipo _classic_ y no necesita ning√∫n permiso. Para generarlo, ve a: 'Settings' ‚Üí 'Developer settings' ‚Üí 'Personal access tokens'.
|_github++_++pat++_++11APW_
|S√≠

|_docker++_++registries_
|_Registries_ de Docker accesibles por los nodos. Para EKS no hace falta autenticaci√≥n, ya que se hace autom√°ticamente con las credenciales del usuario.
|Ver el <<ejemplo_de_descriptor, Ejemplo de descriptor>>
|S√≠, para _registries_ no autenticados.

|_helm++_++repository_
|Repositorio de Helm para la instalaci√≥n de los _charts_ de Stratio.
|Ver el <<ejemplo_de_descriptor, Ejemplo de descriptor>>
|S√≠, para repositorios no autenticados.
|===

NOTE: Cualquier cambio en _spec.credentials_ debe hacerse con todas las credenciales en el descriptor del _cluster_ y eliminando previamente el _secrets.yml_.

=== Redes

Como se ha mencionado anteriormente, el instalador permite utilizar elementos de red del proveedor _cloud_ creados con anterioridad (por ejemplo, por un equipo de seguridad de redes), posibilitando as√≠ las arquitecturas que mejor se adapten a las necesidades.

Tanto el VPC como las _subnets_ deber√°n estar creadas en el proveedor _cloud_. Las _subnets_ podr√°n ser privadas o p√∫blicas, pero en el √∫ltimo caso deber√°n contar con un _NAT gateway_ y un _Internet Gateway_ en el mismo VPC. En caso de indicar _subnets_ de ambos tipos, los nodos _worker_ se desplegar√°n en _subnets_ privadas.

_Stratio KEOS_ no gestionar√° el ciclo de vida de los objetos creados previamente.

[cols="1,4,2,1"]
|===
^|Nombre ^|Descripci√≥n ^|Ejemplo ^|Opcional

|_vpc++_++id_
|VPC ID.
|vpc-0264503b8761ff69f
|S√≠

|_subnets_
|_Array_ de _subnet_'s IDs.
a|

[source,yaml]
----
- subnet_id: subnet-0df..
- subnet_id: subnet-887..
----

|S√≠
|===

=== _control-plane_

En este apartado se indican las particularidades para el _control-plane_ de Kubernetes.

[cols="1,4,2,1"]
|===
^|Nombre ^|Descripci√≥n ^|Ejemplo ^|Opcional

|_aws_
|Valores espec√≠ficos para el _logging_ de EKS (_API Server, audit, authenticator, controller++_++manager_ y/o _scheduler_).
a|

[source,yaml]
----
logging:
  api_server: true
----

|S√≠

|_managed_
|Indica si el _control-plane_ es o no gestionado en el proveedor _cloud_.
|true
|No
|===

=== Nodos _worker_

En este apartado se especifican los grupos de nodos _worker_ y sus caracter√≠sticas.

Las im√°genes utilizadas deber√°n estar soportadas por EKS. Consulta la https://docs.aws.amazon.com/es_es/eks/latest/userguide/eks-optimized-ami.html[creaci√≥n de AMI personalizada para EKS] ^[English]^.

[cols="1,4,2,1"]
|===
^|Nombre ^|Descripci√≥n ^|Ejemplo ^|Opcional

|_name_
|Nombre del grupo. Se utilizar√° como prefijo de las instancias.
|eks-prod-gpu
|No

|_quantity_
|Cantidad de nodos del grupo. Se recomienda que sea m√∫ltiplo de 3 para no tener zonas desbalanceadas.
|15
|No

|_size_
|Tipo de instancia.
|t3.medium
|No

|_max++_++size_/_min++_++size_
|M√°ximo y m√≠nimo n√∫mero de instancias para el autoescalado.
|6/18.
|S√≠

|_az_
|Zona para todo el grupo (invalida el par√°metro _zone++_++distribution_).
|eu-east-1a
|S√≠

|_zone++_++distribution_
|Indica si los nodos se repartir√°n equitativamente en las zonas (por defecto) o no.
|unbalanced
|S√≠

|_node++_++image_
|Imagen de instancia utilizada para los nodos _worker_.
|ami-0de933c15c9b49fb5
|S√≠

|_labels_
|Etiquetas de Kubernetes para los nodos _worker_.
a|

[source,yaml]
----
labels:
  disktype: standard
  gpus: true
----

|S√≠

|_root++_++volume_
|Particularidades del volumen como tama√±o, tipo y encriptaci√≥n.
a|

[source,yaml]
----
root_volume:
  size: 50
  type: gp3
  encrypted: true
----

|S√≠

|_ssh++_++key_
|Clave SSH p√∫blica para acceder a los nodos _worker_. Debe estar creada en AWS previamente. Se recomienda no a√±adir ninguna clave SSH a los nodos.
|prod-key
|S√≠
|===

=== _Stratio KEOS_

Los par√°metros para la fase del _keos-installer_ se indicar√°n en este apartado.

[cols="1,4,2,1"]
|===
^|Nombre ^|Descripci√≥n ^|Ejemplo ^|Opcional

|_flavour_
|_Flavour_ de instalaci√≥n que indica el tama√±o del _cluster_ y resiliencia. Por defecto es "production".
|development
|S√≠

|_version_
|Versi√≥n del _keos-installer_.
|1.0.0
|No
|===

=== Ejemplo de descriptor

Se presentan dos casos de descriptor para demostrar la capacidad de _Stratio Cloud Provisioner_ en ambos proveedores _cloud_ soportados.

==== EKS

En este ejemplo se pueden ver las siguientes particularidades:

* _Cluster_ en AWS con _control-plane_ gestionado (EKS).
* Kubernetes versi√≥n 1.26.x (EKS no tiene en cuenta la versi√≥n _patch_).
* Uso de ECR como _Docker registry_ (no necesita credenciales).
* Uso de VPC y _subnets_ personalizadas (creadas anteriormente). Este apartado es opcional.
* Definici√≥n de una _StorageClass_ por defecto. Este apartado es opcional.
* Se habilitan los _logs_ del _API Server_ en EKS.
* Grupos de nodos _worker_ con m√∫ltiples casu√≠sticas:
** Diferentes tipos de instancia.
** Con clave SSH.
** Con etiquetas de K8s.
** Con rangos de autoescalado.
** En una zona fija.
** Con personalizaciones en el disco.
** Con instancias tipo _spot_.
** Casos de distribuci√≥n en AZs: balanceado y desbalanceado.

[source,yaml]
----
apiVersion: installer.stratio.com/v1beta1
kind: KeosCluster
metadata:
  name: eks-prod
spec:
  infra_provider: aws
  credentials:
    aws:
      region: eu-west-1
      access_key: AKIAT4..
      account_id: '3683675..'
      secret_key: wq3/Vsc..
    github_token: github_pat_11APW..
  k8s_version: v1.26.7
  region: eu-west-1
  external_domain: domain.ext
  networks:
    vpc_id: vpc-02698..
    subnets:
      - subnet_id: subnet-0416d..
      - subnet_id: subnet-0b2f8..
      - subnet_id: subnet-0df75..
  docker_registries:
    - url: AABBCC.dkr.ecr.eu-west-1.amazonaws.com/keos
      auth_required: false
      type: ecr
      keos_registry: true
  helm_repository:
    auth_required: false
    url: http://charts.stratio.com
  storageclass:
    parameters:
      type: gp3
      fsType: ext4
      encrypted: "true"
      labels: "owner=stratio"
  keos:
    flavour: production
    version: 1.0.4
  security:
    aws:
      create_iam: false
  control_plane:
    aws:
      logging:
        api_server: true
    managed: true
  worker_nodes:
    - name: eks-prod-xlarge
      quantity: 6
      max_size: 18
      min_size: 6
      size: m6i.xlarge
      labels:
        disktype: standard
      root_volume:
        size: 50
        type: gp3
        encrypted: true
      ssh_key: stg-key
    - name: eks-prod-medium-spot
      quantity: 4
      zone_distribution: unbalanced
      size: t3.medium
      spot: true
      labels:
        disktype: standard
    - name: eks-prod-medium-az
      quantity: 3
      size: t3.medium
      az: eu-west-1c
----

== Creaci√≥n del _cluster_

_Stratio Cloud Provisioner_ es una herramienta que facilita el aprovisionamiento de los elementos necesarios en el proveedor _cloud_ especificado para la creaci√≥n de un _cluster_ de Kubernetes seg√∫n el <<descriptor_del_cluster, descriptor>> especificado.

Actualmente, este binario incluye las siguientes opciones:

- `--descriptor`: permite indicar la ruta al descriptor del _cluster_.
- `--vault-password`: permite indicar la _passphrase_ de cifrado de las credenciales.
- `--avoid-creation`: no se crea el _cluster_ _worker_, s√≥lo el _cluster_ local.
- `--keep-mgmt`: crea el _cluster_ _worker_ pero deja su gesti√≥n en el _cluster_ local (s√≥lo para entornos *no productivos*).
- `--retain`: permite mantener el _cluster_ local a√∫n sin gesti√≥n.

Para crear un _cluster_, basta con un simple comando (consulta las particularidades de cada proveedor en sus gu√≠as de inicio r√°pido):

[source,bash]
-----
sudo ./cloud-provisioner create cluster --name stratio-pre --descriptor cluster.yaml
Vault Password:
Rewrite Vault Password:
Creating temporary cluster "stratio-pre" ...
 ‚úì Ensuring node image (kindest/node:v1.27.0) üñº
 ‚úì Building Stratio image (stratio-capi-image:v1.27.0) üì∏
 ‚úì Preparing nodes üì¶
 ‚úì Writing configuration üìú
 ‚úì Starting control-plane üïπÔ∏è
 ‚úì Installing CNI üîå
 ‚úì Installing StorageClass üíæ
 ‚úì Installing CAPx üéñÔ∏è
 ‚úì Generating workload cluster manifests üìù
 ‚úì Generating secrets file üìùüóùÔ∏è
 ‚úì Installing keos cluster operator üíª
 ‚úì Creating the workload cluster üí•
 ‚úì Saving the workload cluster kubeconfig üìù
 ‚úì Preparing nodes in workload cluster üì¶
 ‚úì Installing StorageClass in workload cluster üíæ
 ‚úì Enabling workload cluster's self-healing üè•
 ‚úì Installing CAPx in workload cluster üéñÔ∏è
 ‚úì Configuring Network Policy Engine in workload cluster üöß
 ‚úì Installing cluster-autoscaler in workload cluster üóö
 ‚úì Installing keos cluster operator in workload cluster üíª
 ‚úì Creating cloud-provisioner Objects backup üóÑÔ∏è
 ‚úì Moving the management role üóùÔ∏è
 ‚úì Generating the KEOS descriptor üìù

The cluster has been installed, please refer to _Stratio KEOS_ documentation on how to proceed.
-----

Una vez finalizado el proceso, tendr√°s los ficheros necesarios (_keos.yaml_ y _secrets.yml_) para instalar _Stratio KEOS_.

NOTE: Dado que el fichero descriptor para la instalaci√≥n (_keos.yaml_) se regenera en cada ejecuci√≥n, se realiza un _backup_ del anterior en el directorio local con la fecha correspondiente (p.ej. _keos.yaml.2023-07-05@11:19:17~_).
