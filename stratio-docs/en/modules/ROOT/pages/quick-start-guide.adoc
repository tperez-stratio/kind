= Quick start guide

== EKS

=== Prerequisites

* For a user with the required privileges in AWS:
** Create a user for installation.
** Create a policy according to xref:attachment$stratio-eks-policy.json[_stratio-eks-policy.json_].
** Create a policy according to xref:attachment$stratio-aws-temp-policy.json[_stratio-aws-temp-policy.json_] (for provisioning only).
** Attach policies to the user.
** Create an access key.
* Private and public DNS zones created in AWS (optional).
* Customized infrastructure created on AWS (optional).
* Compose the cluster descriptor file.
** User credentials (_access++_++key_ and _secret++_++key_) and account data (region and _account++_++id_), which will be encrypted on first run.
** GitHub token for downloading templates (optional).
** Account data (region and _account++_++id_).
** Data of the infrastructure already created (optional).
** Management of DNS zones created (optional).
** ECR URL.
** External domain of the cluster.
** Enable logging in EKS per component (optional).
** Node groups.
** Information required for the _Stratio KEOS_ installation.

Regarding the _control-plane_, in the cluster descriptor you can indicate that it is a *managed _control-plane_* and the logs that you want to activate from it (API Server, _audit_, _authenticator_, _controller++_++manager_ and/or _scheduler_).

Likewise, *groups of _worker_ nodes* can be indicated with the following options:

* _name_: group name, cannot be repeated.
* _size_: instance type.
* _quantity_: number of _workers_ in the group.
* _min++_++size_: minimum number of nodes for autoscaling (optional).
* _max++_++size_: maximum number of nodes for autoscaling (optional).
* _labels_: node labels in Kubernetes (optional).
* _root++_++volume_: disk specifics (optional).
** _size_: size in GB (default: 30GB).
** _type_: disk type (default: gp2).
** _encrypted_: disk encryption (default: _false_).
* _ssh++_++key_: SSH key for node access (optional). Must exist in the provider.
* _spot_: indicates if the instance is of _spot_ type (optional).
* _node++_++image_: the image of the worker nodes (optional). The indicated image must exist and be compatible with EKS.
* _zone++_++distribution_: indicates whether the number of nodes must be balanced in the zones or not (default: _balanced_).
* _az_: zone of the worker's group (optional). If specified, only this one will be used for the whole group. This parameter overrides what is specified in _zone++_++distribution_.

NOTE: By default, the distribution of nodes will be done in zones a, b and c of the indicated region in a balanced way, therefore, the rest of the division by three of the number of nodes will be discarded. Example: if "quantity=7" is specified, only 2 nodes will be deployed in each of the zones.

==== _keos-installer_

In order to facilitate the installation of _Stratio KEOS_, in the provisioning process a functional _keos.yaml_ file is generated and ready to launch the installation. For this purpose, the version and flavour (_production_, _development_ or _minimal_) can be indicated in the cluster descriptor.

[source,yaml]
----
  keos:
    version: 1.0.2
    flavour: development
----

For any extra customization, the file must be modified before running the _keos-installer_.

===== Considerations

* If you use custom infrastructure, you must indicate the VPC and 3 subnets, one per region zone (a, b and c).
* The Kubernetes version indicated must be supported by EKS.
* The _worker++_++nodes_ group names cannot be repeated.

TIP: For more details, see the xref:ROOT:installation.adoc[installation guide].

==== Installation

You should run the provisioning and installation of the Kubernetes phase from a Linux machine with internet access and a Docker installed.

Once you have downloaded the `.tgz` file of the _cloud-provisioner_, proceed to unzip it and run it with the creation parameters:

[source,console]
----
$ tar xvzf cloud-provisioner-*tar.gz
$ sudo ./bin/cloud-provisioner create cluster --name <cluster_id> --descriptor cluster.yaml
Creating temporary cluster "example-eks" ...
 âœ“ Ensuring node image (kindest/node:v1.27.0) ğŸ–¼
 âœ“ Building Stratio image (stratio-capi-image:v1.27.0) ğŸ“¸
 âœ“ Preparing nodes ğŸ“¦
 âœ“ Writing configuration ğŸ“œ
 âœ“ Starting control-plane ğŸ•¹ï¸
 âœ“ Installing CNI ğŸ”Œ
 âœ“ Installing StorageClass ğŸ’¾
 âœ“ Installing CAPx ğŸ–ï¸
 âœ“ Generating workload cluster manifests ğŸ“
 âœ“ Generating secrets file ğŸ“ğŸ—ï¸
 âœ“ Installing keos cluster operator ğŸ’»
 âœ“ Creating the workload cluster ğŸ’¥
 âœ“ Saving the workload cluster kubeconfig ğŸ“
 âœ“ Preparing nodes in workload cluster ğŸ“¦
 âœ“ Installing StorageClass in workload cluster ğŸ’¾
 âœ“ Enabling workload cluster's self-healing ğŸ¥
 âœ“ Installing CAPx in workload cluster ğŸ–ï¸
 âœ“ Configuring Network Policy Engine in workload cluster ğŸš§
 âœ“ Installing cluster-autoscaler in workload cluster ğŸ—š
 âœ“ Installing keos cluster operator in workload cluster ğŸ’»
 âœ“ Creating cloud-provisioner Objects backup ğŸ—„ï¸
 âœ“ Moving the management role ğŸ—ï¸
 âœ“ Generating the KEOS descriptor ğŸ“
 âœ“ Cleaning up temporary cluster ğŸ§¹

The cluster has been installed, please refer to Stratio KEOS documentation on how to proceed.
----

==== Next steps

At this point, you will have a Kubernetes cluster with the features indicated in the descriptor and you will be able to access the EKS API Server with the AWS CLI as indicated in https://docs.aws.amazon.com/eks/latest/userguide/create-kubeconfig.html[the official documentation].

[source,console]
----
aws eks update-kubeconfig --region <region> --name <cluster_id> --kubeconfig ./<cluster_id>.kubeconfig

kubectl --kubeconfig ./<cluster_id>.kubeconfig get nodes
----

Here, the permissions of _clusterawsadm.json_ can be removed.

Next, proceed to deploy _Stratio KEOS_ *using _keos-installer_*.
